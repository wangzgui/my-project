{% extends "layout.html" %}

{% block title %}ç»Ÿè®¡ä¸­å¿ƒ - æ™ºèƒ½åŠ©æ‰‹{% endblock %}

{% block head %}
<style>
    /* ç»Ÿè®¡å¡ç‰‡æ ·å¼ */
    .stat-card {
        border-radius: 10px;
        border: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        transition: all 0.3s;
    }

    .stat-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }

    .stat-number {
        font-size: 2.2rem;
        font-weight: 700;
    }

    /* æŒ‰é’®æ ·å¼ */
    .ai-btn {
        padding: 8px 20px;
        border-radius: 8px;
        font-weight: 500;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    /* åŠ è½½çŠ¶æ€ */
    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #4e97d8;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* æ¨¡æ€æ¡†æ ·å¼ */
    .ai-analysis-modal .modal-content {
        border-radius: 12px;
        border: none;
    }

    .ai-analysis-modal .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px 12px 0 0;
    }

    .ai-analysis-modal .modal-body {
        max-height: 60vh;
        overflow-y: auto;
    }

    /* è¡¨æ ¼æ ·å¼ */
    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table th {
        background: #f8f9fa;
        padding: 12px 15px;
        font-weight: 600;
        border-bottom: 2px solid #dee2e6;
    }

    .data-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #e9ecef;
    }

    /* æ ‡ç­¾æ ·å¼ */
    .category-badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 500;
    }
</style>
{% endblock %}

{% block main %}
<div class="container py-4">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">ğŸ“Š ç»Ÿè®¡ä¸­å¿ƒ</h2>
            <p class="text-muted mb-0">æ•°æ®åˆ†æä¸æ™ºèƒ½å»ºè®®</p>
        </div>
        <div>
            <button class="btn ai-btn btn-primary" id="aiAnalyzeBtn">
                <i class="bi bi-robot"></i> ğŸ¤– AIæ™ºèƒ½åˆ†æ
            </button>
        </div>
    </div>

    <!-- å‘¨æœŸåˆ‡æ¢ -->
    <div class="card stat-card mb-4">
        <div class="card-body">
            <h5 class="card-title mb-3">ğŸ“… é€‰æ‹©ç»Ÿè®¡å‘¨æœŸ</h5>
            <div class="d-flex align-items-center">
                <div class="btn-group me-3" role="group">
                    <button type="button" class="btn btn-outline-primary active" id="btnToday" onclick="switchPeriod('today')">
                        ä»Šæ—¥
                    </button>
                    <button type="button" class="btn btn-outline-primary" id="btnWeek" onclick="switchPeriod('week')">
                        æœ¬å‘¨
                    </button>
                </div>
                <span class="text-muted" id="periodInfo">ç»Ÿè®¡æ—¶é—´èŒƒå›´ï¼šä»Šæ—¥</span>
            </div>
        </div>
    </div>

    <!-- ç»Ÿè®¡æ‘˜è¦ -->
    <div class="row mb-4">
        <div class="col-md-6 col-lg-3 mb-3">
            <div class="card stat-card h-100">
                <div class="card-body text-center">
                    <div class="text-danger mb-3">
                        <i class="bi bi-cash-stack" style="font-size: 2rem;"></i>
                    </div>
                    <h3 class="stat-number text-danger mb-2" id="totalExpense">Â¥0.00</h3>
                    <p class="text-muted mb-0" id="expenseCount">0ç¬”æ¶ˆè´¹</p>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-3 mb-3">
            <div class="card stat-card h-100">
                <div class="card-body text-center">
                    <div class="text-warning mb-3">
                        <i class="bi bi-graph-up" style="font-size: 2rem;"></i>
                    </div>
                    <h3 class="stat-number text-warning mb-2" id="avgExpense">Â¥0.00</h3>
                    <p class="text-muted mb-0" id="avgExpenseLabel">æ¯ç¬”æ¶ˆè´¹å¹³å‡</p>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-3 mb-3">
            <div class="card stat-card h-100">
                <div class="card-body text-center">
                    <div class="text-success mb-3">
                        <i class="bi bi-calendar-check" style="font-size: 2rem;"></i>
                    </div>
                    <h3 class="stat-number text-success mb-2" id="eventCount">0</h3>
                    <p class="text-muted mb-0" id="eventCountLabel">ä¸ªæ—¥ç¨‹å®‰æ’</p>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-3 mb-3">
            <div class="card stat-card h-100">
                <div class="card-body text-center">
                    <div class="text-info mb-3">
                        <i class="bi bi-clock" style="font-size: 2rem;"></i>
                    </div>
                    <h3 class="stat-number text-info mb-2" id="avgDuration">0h 0m</h3>
                    <p class="text-muted mb-0" id="durationLabel">æ¯æ¬¡æ—¥ç¨‹å¹³å‡æ—¶é•¿</p>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ†ç±»æ¶ˆè´¹ç»Ÿè®¡ -->
    <div class="card stat-card mb-4">
        <div class="card-body">
            <h5 class="card-title mb-3">ğŸ’° åˆ†ç±»æ¶ˆè´¹ç»Ÿè®¡</h5>

            <!-- åŠ è½½çŠ¶æ€ -->
            <div id="categoryLoading" class="text-center py-5">
                <div class="loading-spinner"></div>
                <p class="text-muted mt-2">æ­£åœ¨åŠ è½½åˆ†ç±»æ•°æ®...</p>
            </div>

            <!-- æ— æ•°æ®çŠ¶æ€ -->
            <div id="noCategoryData" class="text-center py-5" style="display: none;">
                <div class="mb-3">
                    <i class="bi bi-cash-coin" style="font-size: 3rem; color: #ddd;"></i>
                </div>
                <h5 class="text-muted">æš‚æ— æ¶ˆè´¹æ•°æ®</h5>
                <p class="text-muted mb-3">ä»Šæ—¥è¿˜æ²¡æœ‰æ¶ˆè´¹è®°å½•</p>
                <a href="/add/expense" class="btn btn-outline-primary btn-sm">æ·»åŠ ç¬¬ä¸€ç¬”æ¶ˆè´¹</a>
            </div>

            <!-- è¡¨æ ¼ -->
            <div id="categoryTable" style="display: none;">
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ç±»åˆ«</th>
                                <th>ç¬”æ•°</th>
                                <th>æ€»é‡‘é¢</th>
                                <th>å¹³å‡é‡‘é¢</th>
                                <th>å æ¯”</th>
                            </tr>
                        </thead>
                        <tbody id="categoryBody"></tbody>
                        <tfoot>
                            <tr>
                                <td colspan="2" class="text-end"><strong>æ€»è®¡</strong></td>
                                <td id="categoryTotal" class="text-danger fw-bold">Â¥0.00</td>
                                <td id="categoryAvg" class="text-warning fw-bold">Â¥0.00</td>
                                <td>100%</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¶ˆè´¹æ˜ç»† -->
    <div class="card stat-card mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0">ğŸ“‹ æ¶ˆè´¹æ˜ç»†</h5>
                <button class="btn btn-sm btn-outline-primary" onclick="analyzeExpenses()">
                    <i class="bi bi-robot"></i> åˆ†ææ¶ˆè´¹
                </button>
            </div>

            <div id="expenseLoading" class="text-center py-5">
                <div class="loading-spinner"></div>
                <p class="text-muted mt-2">æ­£åœ¨åŠ è½½æ¶ˆè´¹æ˜ç»†...</p>
            </div>

            <div id="noExpenseData" class="text-center py-5" style="display: none;">
                <div class="mb-3">
                    <i class="bi bi-receipt" style="font-size: 3rem; color: #ddd;"></i>
                </div>
                <h5 class="text-muted">æš‚æ— æ¶ˆè´¹è®°å½•</h5>
                <p class="text-muted mb-3">è¿˜æ²¡æœ‰æ¶ˆè´¹è®°å½•</p>
                <a href="/add/expense" class="btn btn-outline-primary btn-sm">æ·»åŠ æ¶ˆè´¹è®°å½•</a>
            </div>

            <div id="expenseTable" style="display: none;">
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>æ—¶é—´</th>
                                <th>ç±»åˆ«</th>
                                <th>é¡¹ç›®</th>
                                <th>é‡‘é¢</th>
                                <th>å¤‡æ³¨</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="expenseBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- æ—¥ç¨‹æ˜ç»† -->
    <div class="card stat-card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0">ğŸ“… æ—¥ç¨‹æ˜ç»†</h5>
                <button class="btn btn-sm btn-outline-success" onclick="analyzeEvents()">
                    <i class="bi bi-robot"></i> åˆ†ææ—¥ç¨‹
                </button>
            </div>

            <div id="eventLoading" class="text-center py-5">
                <div class="loading-spinner"></div>
                <p class="text-muted mt-2">æ­£åœ¨åŠ è½½æ—¥ç¨‹æ˜ç»†...</p>
            </div>

            <div id="noEventData" class="text-center py-5" style="display: none;">
                <div class="mb-3">
                    <i class="bi bi-calendar-event" style="font-size: 3rem; color: #ddd;"></i>
                </div>
                <h5 class="text-muted">æš‚æ— æ—¥ç¨‹å®‰æ’</h5>
                <p class="text-muted mb-3">è¿˜æ²¡æœ‰æ—¥ç¨‹å®‰æ’</p>
                <a href="/add/event" class="btn btn-outline-success btn-sm">æ·»åŠ æ—¥ç¨‹å®‰æ’</a>
            </div>

            <div id="eventTable" style="display: none;">
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>æ—¶é—´</th>
                                <th>æ ‡é¢˜</th>
                                <th>æ—¶é•¿</th>
                                <th>å¤‡æ³¨</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="eventBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AIåˆ†ææ¨¡æ€æ¡† -->
<div class="modal fade ai-analysis-modal" id="aiAnalysisModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-white">ğŸ¤– AIæ™ºèƒ½åˆ†æ</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="aiAnalysisLoading" class="text-center py-5">
                    <div class="loading-spinner"></div>
                    <p class="text-muted mt-3">AIæ­£åœ¨æ€è€ƒä¸­...</p>
                </div>
                <div id="aiAnalysisContent" style="display: none;">
                    <div id="aiAnalysisResult" style="white-space: pre-line; line-height: 1.6;"></div>
                </div>
                <div id="aiAnalysisError" class="text-center py-5" style="display: none;">
                    <div class="text-danger mb-3">
                        <i class="bi bi-emoji-frown" style="font-size: 3rem;"></i>
                    </div>
                    <h5 class="text-danger">AIåˆ†ææš‚æ—¶ä¸å¯ç”¨</h5>
                    <p class="text-muted">è¯·ç¨åé‡è¯•ï¼Œæˆ–è”ç³»ç³»ç»Ÿç®¡ç†å‘˜</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                <button type="button" class="btn btn-outline-primary" onclick="copyAnalysis()">
                    <i class="bi bi-clipboard"></i> å¤åˆ¶
                </button>
                <button type="button" class="btn btn-primary" onclick="shareAnalysis()">
                    <i class="bi bi-share"></i> åˆ†äº«
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
// å…¨å±€å˜é‡
let currentPeriod = 'today';

// é¡µé¢åŠ è½½å®Œæˆ
document.addEventListener('DOMContentLoaded', function() {
    console.log("ç»Ÿè®¡é¡µé¢åŠ è½½å®Œæˆ");

    // ç»‘å®šAIåˆ†ææŒ‰é’®
    document.getElementById('aiAnalyzeBtn').addEventListener('click', function() {
        console.log("AIæ™ºèƒ½åˆ†ææŒ‰é’®è¢«ç‚¹å‡»");
        getAIAnalysis('summary');
    });

    // åŠ è½½ä»Šæ—¥æ•°æ®
    switchPeriod('today');

    // åˆ·æ–°æŒ‰é’®çŠ¶æ€
    updateButton('today');
});

// åˆ‡æ¢å‘¨æœŸ
function switchPeriod(period) {
    console.log("åˆ‡æ¢å‘¨æœŸåˆ°:", period);
    if (currentPeriod === period) return;

    currentPeriod = period;
    updateButton(period);
    document.getElementById('periodInfo').textContent =
        period === 'today' ? 'ç»Ÿè®¡æ—¶é—´èŒƒå›´ï¼šä»Šæ—¥' : 'ç»Ÿè®¡æ—¶é—´èŒƒå›´ï¼šæœ¬å‘¨';

    // åŠ è½½æ•°æ®
    loadData(period);
}

// æ›´æ–°æŒ‰é’®çŠ¶æ€
function updateButton(period) {
    document.querySelectorAll('.btn-outline-primary').forEach(btn => {
        btn.classList.remove('active');
    });
    document.getElementById(period === 'today' ? 'btnToday' : 'btnWeek').classList.add('active');
}

// åŠ è½½æ‰€æœ‰æ•°æ®
async function loadData(period) {
    console.log("åŠ è½½æ•°æ®ï¼Œå‘¨æœŸ:", period);
    await loadSummary(period);
    await loadCategories(period);
    await loadExpenses(period);
    await loadEvents(period);
}

// åŠ è½½æ‘˜è¦æ•°æ®
async function loadSummary(period) {
    try {
        const response = await fetch(`/api/stats/summary?period=${period}`);
        if (!response.ok) throw new Error(`HTTPé”™è¯¯: ${response.status}`);

        const data = await response.json();
        console.log("æ‘˜è¦æ•°æ®:", data);

        document.getElementById('totalExpense').textContent = 'Â¥' + data.total_expense.toFixed(2);
        document.getElementById('expenseCount').textContent = data.expense_count + 'ç¬”æ¶ˆè´¹';
        document.getElementById('avgExpense').textContent = 'Â¥' + (data.expense_count > 0 ?
            (data.total_expense / data.expense_count).toFixed(2) : '0.00');
        document.getElementById('avgExpenseLabel').textContent =
            period === 'today' ? 'æ¯ç¬”æ¶ˆè´¹å¹³å‡' : 'æ¯æ—¥æ¶ˆè´¹å¹³å‡';
        document.getElementById('eventCount').textContent = data.event_count;
        document.getElementById('eventCountLabel').textContent = 'ä¸ªæ—¥ç¨‹å®‰æ’';

        const hours = Math.floor(data.avg_duration / 60);
        const minutes = Math.round(data.avg_duration % 60);
        document.getElementById('avgDuration').textContent = hours + 'h ' + minutes + 'm';
        document.getElementById('durationLabel').textContent = 'æ¯æ¬¡æ—¥ç¨‹å¹³å‡æ—¶é•¿';

    } catch (error) {
        console.error("åŠ è½½æ‘˜è¦å¤±è´¥:", error);
    }
}

// åŠ è½½åˆ†ç±»æ•°æ®
async function loadCategories(period) {
    const loadingEl = document.getElementById('categoryLoading');
    const noDataEl = document.getElementById('noCategoryData');
    const tableEl = document.getElementById('categoryTable');

    loadingEl.style.display = 'block';
    noDataEl.style.display = 'none';
    tableEl.style.display = 'none';

    try {
        const response = await fetch(`/api/stats/categories?period=${period}`);
        if (!response.ok) throw new Error(`HTTPé”™è¯¯: ${response.status}`);

        const data = await response.json();
        console.log("åˆ†ç±»æ•°æ®:", data);

        loadingEl.style.display = 'none';

        if (!data.categories || data.categories.length === 0) {
            noDataEl.style.display = 'block';
            return;
        }

        tableEl.style.display = 'block';
        noDataEl.style.display = 'none';

        const tbody = document.getElementById('categoryBody');
        let totalAmount = 0;
        let totalCount = 0;
        let html = '';

        data.categories.forEach(category => {
            if (category.total_amount > 0) {
                totalAmount += category.total_amount;
                totalCount += category.count || 1;
                const percentage = data.total_expense > 0 ? ((category.total_amount / data.total_expense) * 100).toFixed(1) : 0;
                const avgAmount = (category.count && category.count > 0) ? (category.total_amount / category.count).toFixed(2) : category.total_amount.toFixed(2);

                html += `
                <tr>
                    <td><span class="category-badge" style="background: ${category.color || '#6c757d'}; color: white;">${category.name}</span></td>
                    <td>${category.count || 1}ç¬”</td>
                    <td class="text-danger fw-bold">Â¥${category.total_amount.toFixed(2)}</td>
                    <td>Â¥${avgAmount}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="progress flex-grow-1" style="height: 8px;">
                                <div class="progress-bar" style="width: ${percentage}%; background-color: ${category.color || '#6c757d'}"></div>
                            </div>
                            <span class="ms-2">${percentage}%</span>
                        </div>
                    </td>
                </tr>`;
            }
        });

        tbody.innerHTML = html;
        document.getElementById('categoryTotal').textContent = 'Â¥' + totalAmount.toFixed(2);
        document.getElementById('categoryAvg').textContent = 'Â¥' + (totalCount > 0 ? (totalAmount / totalCount).toFixed(2) : '0.00');

    } catch (error) {
        console.error("åŠ è½½åˆ†ç±»æ•°æ®å¤±è´¥:", error);
        loadingEl.style.display = 'none';
        noDataEl.style.display = 'block';
    }
}

// åŠ è½½æ¶ˆè´¹æ˜ç»†
async function loadExpenses(period) {
    const loadingEl = document.getElementById('expenseLoading');
    const noDataEl = document.getElementById('noExpenseData');
    const tableEl = document.getElementById('expenseTable');

    loadingEl.style.display = 'block';
    noDataEl.style.display = 'none';
    tableEl.style.display = 'none';

    try {
        const response = await fetch(`/api/stats/expenses/details?period=${period}`);
        if (!response.ok) throw new Error(`HTTPé”™è¯¯: ${response.status}`);

        const data = await response.json();
        console.log("æ¶ˆè´¹æ˜ç»†:", data);

        loadingEl.style.display = 'none';

        if (!data.expenses || data.expenses.length === 0) {
            noDataEl.style.display = 'block';
            return;
        }

        tableEl.style.display = 'block';
        noDataEl.style.display = 'none';

        const tbody = document.getElementById('expenseBody');
        let html = '';

        data.expenses.forEach(expense => {
            const date = new Date(expense.event_time);
            const dateStr = date.toLocaleDateString('zh-CN', {
                month: '2-digit',
                day: '2-digit'
            });
            const timeStr = date.toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit'
            });

            html += `
            <tr>
                <td><small>${dateStr} ${timeStr}</small></td>
                <td><span class="category-badge bg-primary">${expense.category || 'æœªåˆ†ç±»'}</span></td>
                <td><strong>${expense.title}</strong></td>
                <td class="text-danger fw-bold">Â¥${parseFloat(expense.amount).toFixed(2)}</td>
                <td><small class="text-muted">${expense.notes || '-'}</small></td>
                <td>
                    <a href="/edit/${expense.id}" class="btn btn-sm btn-outline-secondary">ç¼–è¾‘</a>
                </td>
            </tr>`;
        });

        tbody.innerHTML = html;

    } catch (error) {
        console.error("åŠ è½½æ¶ˆè´¹æ˜ç»†å¤±è´¥:", error);
        loadingEl.style.display = 'none';
        noDataEl.style.display = 'block';
    }
}

// åŠ è½½æ—¥ç¨‹æ˜ç»†
async function loadEvents(period) {
    const loadingEl = document.getElementById('eventLoading');
    const noDataEl = document.getElementById('noEventData');
    const tableEl = document.getElementById('eventTable');

    loadingEl.style.display = 'block';
    noDataEl.style.display = 'none';
    tableEl.style.display = 'none';

    try {
        const response = await fetch(`/api/stats/events/details?period=${period}`);
        if (!response.ok) throw new Error(`HTTPé”™è¯¯: ${response.status}`);

        const data = await response.json();
        console.log("æ—¥ç¨‹æ˜ç»†:", data);

        loadingEl.style.display = 'none';

        if (!data.events || data.events.length === 0) {
            noDataEl.style.display = 'block';
            return;
        }

        tableEl.style.display = 'block';
        noDataEl.style.display = 'none';

        const tbody = document.getElementById('eventBody');
        let html = '';

        data.events.forEach(event => {
            const date = new Date(event.event_time);
            const dateStr = date.toLocaleDateString('zh-CN', {
                month: '2-digit',
                day: '2-digit'
            });
            const timeStr = date.toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit'
            });

            let duration = '';
            if (event.duration) {
                const hours = Math.floor(event.duration / 60);
                const minutes = event.duration % 60;
                duration = hours + 'å°æ—¶' + minutes + 'åˆ†é’Ÿ';
            } else {
                duration = '-';
            }

            html += `
            <tr>
                <td><small>${dateStr} ${timeStr}</small></td>
                <td><strong>${event.title}</strong></td>
                <td><span class="badge bg-info">${duration}</span></td>
                <td><small class="text-muted">${event.notes || '-'}</small></td>
                <td>
                    <a href="/edit/${event.id}" class="btn btn-sm btn-outline-secondary">ç¼–è¾‘</a>
                </td>
            </tr>`;
        });

        tbody.innerHTML = html;

    } catch (error) {
        console.error("åŠ è½½æ—¥ç¨‹æ˜ç»†å¤±è´¥:", error);
        loadingEl.style.display = 'none';
        noDataEl.style.display = 'block';
    }
}

// AIåˆ†æ
async function getAIAnalysis(type) {
    console.log("å¼€å§‹AIåˆ†æï¼Œç±»å‹:", type);

    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    const modal = new bootstrap.Modal(document.getElementById('aiAnalysisModal'));
    modal.show();

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    document.getElementById('aiAnalysisLoading').style.display = 'block';
    document.getElementById('aiAnalysisContent').style.display = 'none';
    document.getElementById('aiAnalysisError').style.display = 'none';

    try {
        const response = await fetch('/api/ai/analyze', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                type: type,
                period: currentPeriod
            })
        });

        if (!response.ok) {
            throw new Error(`HTTPé”™è¯¯: ${response.status}`);
        }

        const data = await response.json();
        console.log("AIåˆ†æç»“æœ:", data);

        if (!data.success) {
            throw new Error(data.error || "åˆ†æå¤±è´¥");
        }

        // æ˜¾ç¤ºç»“æœ
        document.getElementById('aiAnalysisLoading').style.display = 'none';
        document.getElementById('aiAnalysisContent').style.display = 'block';
        document.getElementById('aiAnalysisError').style.display = 'none';

        const resultElement = document.getElementById('aiAnalysisResult');
        resultElement.innerHTML = formatAiSuggestion(data.suggestion);

    } catch (error) {
        console.error("AIåˆ†æå¤±è´¥:", error);
        document.getElementById('aiAnalysisLoading').style.display = 'none';
        document.getElementById('aiAnalysisContent').style.display = 'none';
        document.getElementById('aiAnalysisError').style.display = 'block';

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        document.getElementById('aiAnalysisError').innerHTML = `
            <div class="text-danger mb-3">
                <i class="bi bi-emoji-frown" style="font-size: 3rem;"></i>
            </div>
            <h5 class="text-danger">AIåˆ†ææš‚æ—¶ä¸å¯ç”¨</h5>
            <p class="text-muted">é”™è¯¯ä¿¡æ¯: ${error.message}</p>
            <button class="btn btn-outline-primary btn-sm mt-2" onclick="getLocalSuggestion('${type}')">
                ä½¿ç”¨æœ¬åœ°å»ºè®®
            </button>
        `;
    }
}

// åˆ†ææ¶ˆè´¹
function analyzeExpenses() {
    getAIAnalysis('expense');
}

// åˆ†ææ—¥ç¨‹
function analyzeEvents() {
    getAIAnalysis('event');
}

// ä½¿ç”¨æœ¬åœ°å»ºè®®
function getLocalSuggestion(type) {
    const suggestions = {
        expense: [
            "ğŸ¯ ä½ çš„æ¶ˆè´¹è®°å½•çœ‹èµ·æ¥è¿˜ä¸é”™ï¼ç»§ç»­ä¿æŒç†æ€§æ¶ˆè´¹ï¼Œæ³¨æ„æ§åˆ¶ä¸å¿…è¦çš„å¼€æ”¯ã€‚",
            "ğŸ’° ä»Šæ—¥æ¶ˆè´¹è®°å½•å·²åŠ è½½å®Œæ¯•ï¼Œå»ºè®®ä¸ºæ¯ç¬”æ¶ˆè´¹è®°å½•å¤‡æ³¨ï¼Œæ–¹ä¾¿åç»­å¤ç›˜ã€‚",
            "ğŸ“Š æ¶ˆè´¹ä¹ æƒ¯å…»æˆä¸­ï¼Œè®°å¾—åšæŒè®°è´¦ï¼Œæœˆæœ«ä¼šæœ‰æ„æƒ³ä¸åˆ°çš„æ”¶è·å“¦ï¼"
        ],
        event: [
            "ğŸ“… ä½ çš„æ—¥ç¨‹å®‰æ’äº•äº•æœ‰æ¡ï¼åˆç†è§„åˆ’æ—¶é—´ï¼Œè®©æ¯ä¸€å¤©éƒ½é«˜æ•ˆå……å®ã€‚",
            "â° æ—¥ç¨‹ç®¡ç†åšå¾—ä¸é”™ï¼å»ºè®®ä¸ºé‡è¦æ—¥ç¨‹è®¾ç½®æå‰æé†’ï¼Œé¿å…é—æ¼ã€‚",
            "ğŸ¯ æ—¶é—´å°±æ˜¯é‡‘é’±ï¼Œç»§ç»­ä¿æŒè¿™æ ·çš„æ—¥ç¨‹è§„åˆ’ä¹ æƒ¯ï¼Œä½ ä¼šæ”¶è·æ›´å¤šï¼"
        ],
        summary: [
            "ğŸ¤– ä»Šæ—¥æ•°æ®åŠ è½½å®Œæˆï¼æ•´ä½“æ¥è¯´ï¼Œä½ çš„æ—¥ç¨‹å’Œæ¶ˆè´¹è®°å½•éƒ½å¾ˆæ¸…æ™°ã€‚ç»§ç»­ä¿æŒï¼",
            "ğŸ“ˆ ä»Šæ—¥çš„ç»Ÿè®¡æ•°æ®æ˜¾ç¤ºä½ çš„ç”Ÿæ´»å¾ˆæœ‰æ¡ç†ï¼ŒåšæŒä¸‹å»ä¼šæœ‰æ›´å¤šæ”¶è·ï¼",
            "ğŸ’¡ æ•°æ®è®°å½•æ˜¯è‡ªæˆ‘ç®¡ç†çš„ç¬¬ä¸€æ­¥ï¼Œä½ å·²ç»èµ°åœ¨æ­£ç¡®çš„é“è·¯ä¸Šï¼"
        ]
    };

    const suggestion = suggestions[type]?.[Math.floor(Math.random() * suggestions[type].length)] ||
        "ğŸ‰ æ­å–œï¼ä½ çš„æ•°æ®å·²æˆåŠŸåŠ è½½ï¼Œç»§ç»­è®°å½•æ¯ä¸€å¤©çš„ç²¾å½©ï¼";

    document.getElementById('aiAnalysisLoading').style.display = 'none';
    document.getElementById('aiAnalysisContent').style.display = 'block';
    document.getElementById('aiAnalysisError').style.display = 'none';
    document.getElementById('aiAnalysisResult').innerHTML = formatAiSuggestion(suggestion);
}

// æ ¼å¼åŒ–AIå»ºè®®
function formatAiSuggestion(text) {
    if (!text) return '';

    // å°†æ¢è¡Œç¬¦è½¬æ¢ä¸ºHTML
    let formattedText = text.replace(/\n/g, '<br>');

    // æ·»åŠ è¡¨æƒ…ç¬¦å·
    formattedText = formattedText
        .replace(/æé†’/g, 'ğŸ”” æé†’')
        .replace(/å»ºè®®/g, 'ğŸ’¡ å»ºè®®')
        .replace(/æ³¨æ„/g, 'âš ï¸ æ³¨æ„')
        .replace(/æ­å–œ/g, 'ğŸ‰ æ­å–œ')
        .replace(/ç»§ç»­/g, 'ğŸš€ ç»§ç»­')
        .replace(/åŠ æ²¹/g, 'ğŸ’ª åŠ æ²¹')
        .replace(/è®°å½•/g, 'ğŸ“ è®°å½•')
        .replace(/æ—¶é—´/g, 'â° æ—¶é—´')
        .replace(/é‡‘é’±/g, 'ğŸ’° é‡‘é’±')
        .replace(/è§„åˆ’/g, 'ğŸ—ºï¸ è§„åˆ’')
        .replace(/å¤ç›˜/g, 'ğŸ” å¤ç›˜');

    return formattedText;
}

// å¤åˆ¶åˆ†æç»“æœ
function copyAnalysis() {
    const text = document.getElementById('aiAnalysisResult').textContent;
    navigator.clipboard.writeText(text).then(() => {
        alert('åˆ†æç»“æœå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
    }).catch(err => {
        console.error('å¤åˆ¶å¤±è´¥:', err);
        alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
    });
}

// åˆ†äº«åˆ†æç»“æœ
function shareAnalysis() {
    const text = document.getElementById('aiAnalysisResult').textContent;
    const shareUrl = window.location.href;
    const shareText = `ğŸ¤– æˆ‘çš„æ™ºèƒ½åŠ©æ‰‹åˆ†ææŠ¥å‘Šï¼š\n\n${text}\n\næ¥è‡ª: ${shareUrl}`;

    if (navigator.share) {
        navigator.share({
            title: 'æ™ºèƒ½åŠ©æ‰‹åˆ†ææŠ¥å‘Š',
            text: text,
            url: shareUrl
        });
    } else {
        navigator.clipboard.writeText(shareText).then(() => {
            alert('å·²å¤åˆ¶åˆ†äº«å†…å®¹åˆ°å‰ªè´´æ¿ï¼');
        }).catch(err => {
            console.error('åˆ†äº«å¤±è´¥:', err);
        });
    }
}
</script>
{% endblock %}
