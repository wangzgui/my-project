{% extends "layout.html" %}

{% block title %}æ·»åŠ æ—¥ç¨‹å®‰æ’{% endblock %}

{% block main %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- è¿”å›æŒ‰é’® -->
            <div class="mb-4">
                <a href="/add" class="btn btn-outline-secondary">
                    &larr; è¿”å›é€‰æ‹©
                </a>
            </div><!-- ä¸»å¡ç‰‡ -->
        <div class="card border-0 shadow">
        <div class="card-header bg-primary text-white py-3">
                    <h2 class="h4 mb-0">ğŸ“… æ·»åŠ æ—¥ç¨‹å®‰æ’</h2>
                </div>
                <div class="card-body p-4">
                    <form method="post" action="/add/event" id="eventForm">
                        <!-- æ ‡é¢˜ -->
                        <div class="mb-4">
                            <label for="title" class="form-label fw-bold">æ ‡é¢˜/é¡¹ç›®åç§°</label>
                            <input type="text" class="form-control form-control-lg" id="title" name="title"
                                   placeholder="ä¾‹å¦‚ï¼šå›¢é˜Ÿå‘¨ä¼šã€é¡¹ç›®è®¨è®ºã€å¥èº«è®¡åˆ’" required>
                        </div><!-- æ—¶é—´å®‰æ’ -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="start_time" class="form-label fw-bold">å¼€å§‹æ—¶é—´</label>
                            <input type="datetime-local" class="form-control" id="start_time" name="start_time"
                                       value="{{ default_time }}" required>
                            </div>
                            <div class="col-md-6">
                            <label for="end_time" class="form-label fw-bold">ç»“æŸæ—¶é—´</label>
                        <input type="datetime-local" class="form-control" id="end_time" name="end_time"
                                       value="{{ one_hour_later }}" required>
                        </div>
                        </div><!-- æŒç»­æ—¶é—´è®¡ç®— -->
                        <div class="alert alert-info mb-4" id="durationDisplay">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-bold">â±ï¸ é¢„è®¡æŒç»­æ—¶é—´ï¼š</span>
                                <span class="h5 mb-0" id="durationText">1å°æ—¶0åˆ†é’Ÿ</span>
                            </div>
                        </div><!-- å¤‡æ³¨è¯´æ˜ -->
                        <div class="mb-4">
                            <label for="notes" class="form-label fw-bold">å¤‡æ³¨è¯´æ˜</label>
                            <textarea class="form-control" id="notes" name="notes" rows="4"
                             placeholder="è¯·è¾“å…¥æ—¥ç¨‹çš„è¯¦ç»†ä¿¡æ¯ã€å‡†å¤‡äº‹é¡¹ã€å‚ä¼šäººå‘˜ã€æ³¨æ„äº‹é¡¹ç­‰..."></textarea>
                        </div><!-- AIæ™ºèƒ½å»ºè®® -->
                        <div class="card mb-4 border-primary">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">âœ¨ AIæ™ºèƒ½å»ºè®®</h5>
                            </div>
                            <div class="card-body">
                                <p class="text-muted mb-3">è®©AIåŠ©æ‰‹ä¸ºæ‚¨çš„æ—¥ç¨‹æä¾›ä¸ªæ€§åŒ–å»ºè®®å’Œæé†’</p>

<button type="button" id="aiSuggestBtn" class="btn btn-outline-primary w-100 py-3 mb-3" onclick="getAISuggestion()">
                                    <span id="aiIcon">ğŸ¤–</span>
                                    <span id="aiBtnText">è·å–AIæ™ºèƒ½å»ºè®®</span>
                                </button>

                                <div class="alert alert-light border" id="aiResponse" style="display: none;">
                                    <div class="d-flex">
                                        <div class="me-3">ğŸ’¡</div>
                                        <div>
                                            <strong>AIå»ºè®®ï¼š</strong>
                                            <span id="aiText"></span>
                                            <input type="hidden" id="ai_comment" name="ai_comment" value="">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div><!-- æäº¤æŒ‰é’® -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg py-3">
                                ğŸ’¾ ä¿å­˜æ—¥ç¨‹å®‰æ’
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const startTime = document.getElementById('start_time');
    const endTime = document.getElementById('end_time');
    const durationText = document.getElementById('durationText');
    const durationDisplay = document.getElementById('durationDisplay');

    // æ—¶é—´è®¡ç®—å‡½æ•°
    function calculateDuration() {
        if (startTime.value && endTime.value) {
            const start = new Date(startTime.value);
            const end = new Date(endTime.value);

            if (end > start) {
                const durationMs = end - start;
                const hours = Math.floor(durationMs / (1000 * 60 * 60));
                const minutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));
                durationText.textContent = `${hours}å°æ—¶${minutes}åˆ†é’Ÿ`;
                durationDisplay.style.display = 'block';
            } else {
                durationText.textContent = 'ç»“æŸæ—¶é—´å¿…é¡»æ™šäºå¼€å§‹æ—¶é—´';
                durationDisplay.className = 'alert alert-danger mb-4';
            }
        }
    }

    // å®æ—¶è®¡ç®—æŒç»­æ—¶é—´
    startTime.addEventListener('change', calculateDuration);
    endTime.addEventListener('change', calculateDuration);

    // è¡¨å•éªŒè¯
    document.getElementById('eventForm').addEventListener('submit', function(e) {
        if (!startTime.value || !endTime.value) {
            e.preventDefault();
            alert('è¯·å¡«å†™å¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´ï¼');
            return false;
        }

        const start = new Date(startTime.value);
        const end = new Date(endTime.value);

        if (end <= start) {
            e.preventDefault();
            alert('ç»“æŸæ—¶é—´å¿…é¡»æ™šäºå¼€å§‹æ—¶é—´ï¼');
            return false;
        }

        return true;
    });

    // AIå»ºè®®åŠŸèƒ½
    window.getAISuggestion = async function () {
    const btn = document.getElementById('aiSuggestBtn');
    const aiText = document.getElementById('aiText');
    const aiResponse = document.getElementById('aiResponse');
    const aiCommentInput = document.getElementById('ai_comment');

    // è·å–è¡¨å•æ•°æ®
    const title = document.getElementById('title').value.trim();
    const startTime = document.getElementById('start_time').value;
    const endTime = document.getElementById('end_time').value;
    const notes = document.getElementById('notes').value.trim();

    // éªŒè¯å¿…éœ€å­—æ®µ
    if (!title) {
        alert('è¯·å…ˆå¡«å†™æ—¥ç¨‹æ ‡é¢˜ï¼');
        return;
    }

    // è®¾ç½®åŠ è½½çŠ¶æ€
    btn.disabled = true;
    document.getElementById('aiBtnText').textContent = 'AIæ€è€ƒä¸­...';
    document.getElementById('aiIcon').textContent = 'â³';

    try {
        // 1. æ„å»ºè¯·æ±‚æ•°æ®
        const requestData = {
            type: 'event',
            title: title,
            notes: notes
        };

        // å¦‚æœæœ‰æ—¶é—´ä¿¡æ¯ï¼ŒåŠ å…¥
        if (startTime) {
            requestData.start_time = startTime;
        }
        if (endTime) {
            requestData.end_time = endTime;
        }

        // 2. è°ƒç”¨åç«¯çš„AIå»ºè®®æ¥å£
        const response = await fetch('/api/ai/suggest', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });

        if (!response.ok) {
            throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
        }

        const data = await response.json();

        // 3. å¤„ç†å“åº”
        if (data.success) {
            // æ˜¾ç¤ºAIå›å¤
            aiText.textContent = data.suggestion;
            aiResponse.style.display = 'block';
            aiCommentInput.value = data.suggestion;

            // æ¢å¤æŒ‰é’®çŠ¶æ€
            btn.disabled = false;
            document.getElementById('aiBtnText').textContent = 'é‡æ–°è·å–AIå»ºè®®';
            document.getElementById('aiIcon').textContent = 'âœ¨';
        } else {
            // å¦‚æœåç«¯APIå¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨çš„æ¨¡æ‹Ÿå›å¤
            throw new Error(data.error || 'AIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨');
        }

    } catch (error) {
        console.error('AIå»ºè®®è¯·æ±‚å¤±è´¥:', error);

        // 4. å¦‚æœå‡ºé”™ï¼Œä½¿ç”¨æ¨¡æ‹Ÿå›å¤ï¼ˆåå¤‡æ–¹æ¡ˆï¼‰
        const mockResponses = [
            "ğŸ¯ è¿™ä¸ªæ—¥ç¨‹å®‰æ’å¾ˆåˆç†ï¼å»ºè®®æå‰10åˆ†é’Ÿå‡†å¤‡ï¼Œç¡®ä¿è®¾å¤‡è°ƒè¯•å®Œæ¯•ã€‚",
            "â° æ—¶é—´è§„åˆ’ä¸é”™ï¼è®°å¾—é¢„ç•™5-10åˆ†é’Ÿç¼“å†²æ—¶é—´ä»¥é˜²æ„å¤–å»¶è¿Ÿã€‚",
            "ğŸ’¡ è€ƒè™‘ä¸ºè¿™ä¸ªæ—¥ç¨‹è®¾å®šä¸€ä¸ªæ˜ç¡®çš„ç›®æ ‡ï¼Œè¿™æ ·æ•ˆç‡ä¼šæ›´é«˜å“¦ï¼",
            "ğŸ¤ å¦‚æœæœ‰å‚ä¼šè€…ï¼Œå»ºè®®æå‰å‘é€ä¼šè®®è®®ç¨‹å’Œææ–™ã€‚",
            "â˜• é•¿æ—¶é—´æ—¥ç¨‹ï¼Ÿè®°å¾—å®‰æ’çŸ­æš‚çš„ä¼‘æ¯æ—¶é—´ä¿æŒç²¾åŠ›å……æ²›ã€‚",
            "ğŸ“… å»ºè®®å°†è¿™ä¸ªæ—¥ç¨‹æ·»åŠ åˆ°æ—¥å†æé†’ï¼Œé¿å…å¿˜è®°ã€‚",
            "âœï¸ å¯ä»¥æå‰åˆ—å‡ºè®®ç¨‹è¦ç‚¹ï¼Œè®©ä¼šè®®æ›´é«˜æ•ˆã€‚",
            "ğŸ”” è®¾ç½®å¤šä¸ªæé†’ï¼šæå‰15åˆ†é’Ÿã€5åˆ†é’Ÿå„ä¸€æ¬¡ã€‚"
        ];

        const response = mockResponses[Math.floor(Math.random() * mockResponses.length)];
        aiText.textContent = `ğŸ¤– ${response}ï¼ˆæœ¬åœ°å»ºè®®ï¼‰`;
        aiResponse.style.display = 'block';
        aiCommentInput.value = response;

        // æ¢å¤æŒ‰é’®çŠ¶æ€
        btn.disabled = false;
        document.getElementById('aiBtnText').textContent = 'é‡æ–°è·å–AIå»ºè®®';
        document.getElementById('aiIcon').textContent = 'âš ï¸';

        // æ˜¾ç¤ºé”™è¯¯æç¤º
        alert('AIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œå·²ä½¿ç”¨æœ¬åœ°å»ºè®®ã€‚é”™è¯¯ï¼š' + error.message);
    }
}

    // åˆå§‹åŒ–è®¡ç®—
    calculateDuration();
});
</script>
{% endblock %}
