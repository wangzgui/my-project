{% extends "layout.html" %}

{% block title %}æˆ‘çš„æ—¶é—´è¡¨ - æ™ºèƒ½åŠ©æ‰‹{% endblock %}

{% block head %}
<style>
/* å¤§ç½‘æ ¼æ ·å¼ */
.time-grid-container {
    display: grid;
    grid-template-columns: 1fr;
    grid-gap: 15px;
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
}

/* å¤§æ—¶é—´å— - æ¯ä¸ªå—2-3å°æ—¶ */
.time-slot-large {
    background: white;
    border-radius: 12px;
    border: 2px solid #e9ecef;
    padding: 20px;
    position: relative;
    min-height: 180px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
}

.time-slot-large:hover {
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

/* å¤§æ—¶é—´å—æ ‡é¢˜ */
.time-slot-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #f1f3f4;
}

.time-slot-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #333;
    display: flex;
    align-items: center;
    gap: 8px;
}

.time-slot-title .time-icon {
    font-size: 1.3rem;
}

.time-slot-hours {
    color: #666;
    font-size: 0.9rem;
    background: #f8f9fa;
    padding: 4px 12px;
    border-radius: 20px;
}

/* äº‹ä»¶å®¹å™¨ - å¤§å—é‡Œé¢çš„å°ç›’å­ */
.events-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 12px;
    min-height: 120px;
}

/* äº‹ä»¶å°å¡ç‰‡ */
.event-mini-card {
    background: white;
    border-radius: 8px;
    padding: 12px 15px;
    border-left: 4px solid;
    box-shadow: 0 2px 5px rgba(0,0,0,0.06);
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
}

.event-mini-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 12px rgba(0,0,0,0.1);
}

/* æ—¥ç¨‹å¡ç‰‡ - ç»¿è‰²ç³» */
.event-mini-card.schedule {
    border-left-color: #4CAF50;
    background: linear-gradient(135deg, rgba(76, 175, 80, 0.05), rgba(76, 175, 80, 0.02));
}

.event-mini-card.schedule::before {
    content: 'ğŸ“…';
    position: absolute;
    right: 10px;
    top: 10px;
    opacity: 0.3;
    font-size: 1.5rem;
}

/* æ¶ˆè´¹å¡ç‰‡ - æ©™è‰²ç³» */
.event-mini-card.expense {
    border-left-color: #FF9800;
    background: linear-gradient(135deg, rgba(255, 152, 0, 0.05), rgba(255, 152, 0, 0.02));
}

.event-mini-card.expense::before {
    content: 'ğŸ’°';
    position: absolute;
    right: 10px;
    top: 10px;
    opacity: 0.3;
    font-size: 1.5rem;
}

/* å¡ç‰‡å†…å®¹ */
.event-mini-time {
    font-size: 0.8rem;
    color: #666;
    margin-bottom: 4px;
    font-weight: 500;
}

.event-mini-title {
    font-weight: 600;
    font-size: 0.95rem;
    color: #333;
    margin-bottom: 6px;
    line-height: 1.3;
}

.event-mini-details {
    font-size: 0.8rem;
    color: #777;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 8px;
}

.event-mini-amount {
    background: #FFEBEE;
    color: #D32F2F;
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 600;
}

.event-mini-duration {
    background: #E3F2FD;
    color: #1976D2;
    padding: 2px 8px;
    border-radius: 10px;
}

/* ç©ºçŠ¶æ€æç¤º */
.empty-slot {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100px;
    color: #999;
    font-size: 0.9rem;
}

.empty-icon {
    font-size: 1.5rem;
    margin-bottom: 8px;
    opacity: 0.5;
}

/* è§†å›¾åˆ‡æ¢ */
.view-toggle {
    display: flex;
    background: #f8f9fa;
    border-radius: 12px;
    padding: 4px;
    margin-bottom: 25px;
    max-width: 300px;
    margin-left: auto;
    margin-right: auto;
}

.view-btn {
    flex: 1;
    padding: 10px 20px;
    border: none;
    background: none;
    border-radius: 8px;
    color: #666;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
}

.view-btn.active {
    background: white;
    color: #333;
    box-shadow: 0 3px 8px rgba(0,0,0,0.1);
}

/* å“åº”å¼ */
@media (max-width: 768px) {
    .time-grid-container {
        grid-gap: 12px;
        padding: 15px;
    }

    .time-slot-large {
        padding: 15px;
        min-height: 160px;
    }

    .events-container {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block main %}
<div class="container py-4">
    <!-- æ ‡é¢˜ -->
    <div class="text-center mb-5">
        <h1 class="mb-3">ğŸ“… æˆ‘çš„æ—¶é—´è¡¨</h1>
        <p class="text-muted">ä»¥æ¸…æ™°çš„æ—¶é—´å—æŸ¥çœ‹æ‚¨çš„ä¸€å¤©å®‰æ’</p>
    </div>

    <!-- è§†å›¾åˆ‡æ¢ -->
    <div class="view-toggle mb-4">
        <button class="view-btn active" onclick="switchView('grid')">ğŸ“… ç½‘æ ¼è§†å›¾</button>
        <button class="view-btn" onclick="switchView('list')">ğŸ“‹ åˆ—è¡¨è§†å›¾</button>
    </div>

    <!-- å¤§å—ç½‘æ ¼è§†å›¾ -->
    <div id="gridView">
        <div class="time-grid-container">
            <!-- æ—©ä¸Š 6:00-9:00 -->
            <div class="time-slot-large" id="morning1">
                <div class="time-slot-header">
                    <div class="time-slot-title">
                        <span class="time-icon">ğŸŒ…</span>
                        <span>æ¸…æ™¨</span>
                    </div>
                    <span class="time-slot-hours">6:00 - 9:00</span>
                </div>
                <div class="events-container" id="slot-morning1"></div>
            </div>

            <!-- ä¸Šåˆ 9:00-12:00 -->
            <div class="time-slot-large" id="morning2">
                <div class="time-slot-header">
                    <div class="time-slot-title">
                        <span class="time-icon">â˜€ï¸</span>
                        <span>ä¸Šåˆ</span>
                    </div>
                    <span class="time-slot-hours">9:00 - 12:00</span>
                </div>
                <div class="events-container" id="slot-morning2"></div>
            </div>

            <!-- ä¸­åˆ 12:00-15:00 -->
            <div class="time-slot-large" id="afternoon1">
                <div class="time-slot-header">
                    <div class="time-slot-title">
                        <span class="time-icon">ğŸ½ï¸</span>
                        <span>ä¸­åˆ</span>
                    </div>
                    <span class="time-slot-hours">12:00 - 15:00</span>
                </div>
                <div class="events-container" id="slot-afternoon1"></div>
            </div>

            <!-- ä¸‹åˆ 15:00-18:00 -->
            <div class="time-slot-large" id="afternoon2">
                <div class="time-slot-header">
                    <div class="time-slot-title">
                        <span class="time-icon">ğŸŒ¤ï¸</span>
                        <span>ä¸‹åˆ</span>
                    </div>
                    <span class="time-slot-hours">15:00 - 18:00</span>
                </div>
                <div class="events-container" id="slot-afternoon2"></div>
            </div>

            <!-- å‚æ™š 18:00-21:00 -->
            <div class="time-slot-large" id="evening1">
                <div class="time-slot-header">
                    <div class="time-slot-title">
                        <span class="time-icon">ğŸŒ†</span>
                        <span>å‚æ™š</span>
                    </div>
                    <span class="time-slot-hours">18:00 - 21:00</span>
                </div>
                <div class="events-container" id="slot-evening1"></div>
            </div>

            <!-- æ™šä¸Š 21:00-24:00 -->
            <div class="time-slot-large" id="evening2">
                <div class="time-slot-header">
                    <div class="time-slot-title">
                        <span class="time-icon">ğŸŒ™</span>
                        <span>æ™šä¸Š</span>
                    </div>
                    <span class="time-slot-hours">21:00 - 24:00</span>
                </div>
                <div class="events-container" id="slot-evening2"></div>
            </div>
        </div>
    </div>

    <!-- åˆ—è¡¨è§†å›¾ -->
    <div id="listView" style="display: none;">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-4">ğŸ“‹ ä»Šæ—¥æ‰€æœ‰å®‰æ’</h5>
                <div id="eventList"></div>
            </div>
        </div>
    </div>

    <!-- æ— äº‹ä»¶æç¤º -->
    <div id="noEvents" style="display: none;">
        <div class="text-center py-5">
            <div style="font-size: 4rem; color: #e0e0e0; margin-bottom: 1rem;">ğŸ“…</div>
            <h4 class="text-muted">ä»Šå¤©è¿˜æ²¡æœ‰å®‰æ’</h4>
            <p class="text-muted mb-4">å¼€å§‹è§„åˆ’ä½ çš„ä¸€å¤©å§ï¼</p>
            <a href="/add/event" class="btn btn-primary me-2">æ·»åŠ æ—¥ç¨‹</a>
            <a href="/add/expense" class="btn btn-outline-primary">æ·»åŠ æ¶ˆè´¹</a>
        </div>
    </div>
</div>

<!-- äº‹ä»¶è¯¦æƒ…å¼¹çª— -->
<div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="modalContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                <button type="button" class="btn btn-primary" onclick="editEvent()">ç¼–è¾‘</button>
                <button type="button" class="btn btn-outline-danger" onclick="deleteEvent()">åˆ é™¤</button>
            </div>
        </div>
    </div>
</div>

<script>
// ä»Flaskè·å–æ•°æ®
if (typeof window.events === 'undefined') {
    window.events = JSON.parse('{{ events|tojson|safe }}');
}
const today = '{{ today_date }}';

// å®šä¹‰æ—¶é—´åŒºå—
const timeSlots = [
    { id: 'morning1', name: 'æ¸…æ™¨', start: 6, end: 9, icon: 'ğŸŒ…' },
    { id: 'morning2', name: 'ä¸Šåˆ', start: 9, end: 12, icon: 'â˜€ï¸' },
    { id: 'afternoon1', name: 'ä¸­åˆ', start: 12, end: 15, icon: 'ğŸ½ï¸' },
    { id: 'afternoon2', name: 'ä¸‹åˆ', start: 15, end: 18, icon: 'ğŸŒ¤ï¸' },
    { id: 'evening1', name: 'å‚æ™š', start: 18, end: 21, icon: 'ğŸŒ†' },
    { id: 'evening2', name: 'æ™šä¸Š', start: 21, end: 24, icon: 'ğŸŒ™' }
];

// ä¸»æ¸²æŸ“å‡½æ•°
function renderGridView() {
    console.log('å¼€å§‹æ¸²æŸ“ç½‘æ ¼è§†å›¾ï¼Œäº‹ä»¶æ•°é‡ï¼š', events.length);

    // æ¸…ç©ºæ‰€æœ‰åŒºå—
    timeSlots.forEach(slot => {
        const container = document.getElementById('slot-' + slot.id);
        if (container) {
            container.innerHTML = '';
        }
    });

    // å¦‚æœæ²¡æœ‰äº‹ä»¶ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
    if (!events || events.length === 0) {
        document.getElementById('gridView').style.display = 'none';
        document.getElementById('noEvents').style.display = 'block';
        return;
    }

    document.getElementById('gridView').style.display = 'block';
    document.getElementById('noEvents').style.display = 'none';

    // å°†äº‹ä»¶åˆ†é…åˆ°å¯¹åº”çš„æ—¶é—´åŒºå—
    events.forEach(event => {
        if (!event.event_time) return;

        const eventTime = new Date(event.event_time);
        const eventHour = eventTime.getHours();

        // æ‰¾åˆ°äº‹ä»¶æ‰€å±çš„æ—¶é—´åŒºå—
        const slot = timeSlots.find(s => eventHour >= s.start && eventHour < s.end);
        if (!slot) return;

        const container = document.getElementById('slot-' + slot.id);
        if (!container) return;

        // åˆ›å»ºäº‹ä»¶å¡ç‰‡
        const eventCard = createEventCard(event, eventTime);
        container.appendChild(eventCard);
    });

    // å¤„ç†ç©ºåŒºå—
    timeSlots.forEach(slot => {
        const container = document.getElementById('slot-' + slot.id);
        if (container && container.children.length === 0) {
            container.innerHTML = `
                <div class="empty-slot">
                    <div class="empty-icon">ğŸ“­</div>
                    <div>æš‚æ— å®‰æ’</div>
                </div>
            `;
        }
    });
}

// åˆ›å»ºäº‹ä»¶å¡ç‰‡
function createEventCard(event, eventTime) {
    const timeStr = eventTime.toLocaleTimeString('zh-CN', {
        hour: '2-digit',
        minute: '2-digit'
    });

    const card = document.createElement('div');
    card.className = `event-mini-card ${event.type === 'event' ? 'schedule' : 'expense'}`;
    card.onclick = () => showEventDetails(event);

    let cardContent = `
        <div class="event-mini-time">${timeStr}</div>
        <div class="event-mini-title">${event.title}</div>
        <div class="event-mini-details">
    `;

    if (event.type === 'event' && event.duration) {
        const hours = Math.floor(event.duration / 60);
        const minutes = event.duration % 60;
        if (hours > 0 || minutes > 0) {
            cardContent += `<span class="event-mini-duration">${hours}h${minutes}m</span>`;
        }
    } else if (event.type === 'expense' && event.amount) {
        cardContent += `<span class="event-mini-amount">Â¥${event.amount}</span>`;
    }

    if (event.category) {
        cardContent += `<span style="color:#666; font-size:0.8rem">${event.category}</span>`;
    }

    cardContent += `</div>`;
    card.innerHTML = cardContent;

    return card;
}

// æ˜¾ç¤ºåˆ—è¡¨è§†å›¾
function renderListView() {
    const listContainer = document.getElementById('eventList');
    if (!events || events.length === 0) {
        listContainer.innerHTML = '<p class="text-muted text-center py-4">ä»Šå¤©è¿˜æ²¡æœ‰å®‰æ’</p>';
        return;
    }

    let listHTML = '<div class="list-group">';

    events.sort((a, b) => new Date(a.event_time) - new Date(b.event_time)).forEach(event => {
        if (!event.event_time) return;

        const eventTime = new Date(event.event_time);
        const timeStr = eventTime.toLocaleString('zh-CN', {
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });

        listHTML += `
            <a href="#" class="list-group-item list-group-item-action" onclick="showEventDetails(${JSON.stringify(event)})">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${event.type === 'event' ? 'ğŸ“…' : 'ğŸ’°'} ${event.title}</h6>
                    <small>${timeStr}</small>
                </div>
                <p class="mb-1">
                    ${event.type === 'event' ?
                        (event.notes || '') :
                        `Â¥${event.amount} | ${event.category}`
                    }
                </p>
            </a>
        `;
    });

    listHTML += '</div>';
    listContainer.innerHTML = listHTML;
}

// æ˜¾ç¤ºäº‹ä»¶è¯¦æƒ…
let currentEvent = null;

function showEventDetails(event) {
    currentEvent = event;

    const eventTime = new Date(event.event_time);
    const timeStr = eventTime.toLocaleString('zh-CN', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        weekday: 'long'
    });

    document.getElementById('modalTitle').textContent = event.title;

    let modalHTML = `
        <div class="mb-3">
            <span class="badge ${event.type === 'event' ? 'bg-success' : 'bg-warning'} me-2">
                ${event.type === 'event' ? 'æ—¥ç¨‹' : 'æ¶ˆè´¹'}
            </span>
            <span class="text-muted">${timeStr}</span>
        </div>
    `;

    if (event.type === 'event') {
        modalHTML += `
            <p><strong>ğŸ“… ç±»å‹ï¼š</strong>æ—¥ç¨‹å®‰æ’</p>
            ${event.end_time ? `<p><strong>â±ï¸ ç»“æŸæ—¶é—´ï¼š</strong>${new Date(event.end_time).toLocaleTimeString('zh-CN')}</p>` : ''}
            ${event.duration ? `<p><strong>â±ï¸ æŒç»­æ—¶é—´ï¼š</strong>${Math.floor(event.duration/60)}å°æ—¶${event.duration%60}åˆ†é’Ÿ</p>` : ''}
            ${event.notes ? `<p><strong>ğŸ“‹ å¤‡æ³¨ï¼š</strong>${event.notes}</p>` : ''}
        `;
    } else {
        modalHTML += `
            <p><strong>ğŸ’° ç±»å‹ï¼š</strong>æ¶ˆè´¹è®°å½•</p>
            <p><strong>ğŸ’µ é‡‘é¢ï¼š</strong>Â¥${event.amount}</p>
            <p><strong>ğŸ·ï¸ ç±»åˆ«ï¼š</strong>${event.category}</p>
            ${event.notes ? `<p><strong>ğŸ“‹ å¤‡æ³¨ï¼š</strong>${event.notes}</p>` : ''}
        `;
    }

    if (event.ai_comment) {
        modalHTML += `
            <div class="alert alert-info mt-3">
                <strong>ğŸ¤– AIå»ºè®®ï¼š</strong>${event.ai_comment}
            </div>
        `;
    }

    document.getElementById('modalContent').innerHTML = modalHTML;

    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    const modal = new bootstrap.Modal(document.getElementById('eventModal'));
    modal.show();
}

function editEvent() {
    if (currentEvent) {
        window.location.href = `/edit/${currentEvent.id}`;
    }
}

function deleteEvent() {
    if (currentEvent && confirm(`ç¡®å®šè¦åˆ é™¤"${currentEvent.title}"å—ï¼Ÿ`)) {
        window.location.href = `/delete/${currentEvent.id}`;
    }
}

// è§†å›¾åˆ‡æ¢
function switchView(viewType) {
    const gridBtn = document.querySelector('[onclick="switchView(\'grid\')"]');
    const listBtn = document.querySelector('[onclick="switchView(\'list\')"]');

    if (viewType === 'grid') {
        gridBtn.classList.add('active');
        listBtn.classList.remove('active');
        document.getElementById('gridView').style.display = 'block';
        document.getElementById('listView').style.display = 'none';
        renderGridView();
    } else {
        gridBtn.classList.remove('active');
        listBtn.classList.add('active');
        document.getElementById('gridView').style.display = 'none';
        document.getElementById('listView').style.display = 'block';
        renderListView();
    }
}

// é¡µé¢åŠ è½½å®Œæˆ
document.addEventListener('DOMContentLoaded', function() {
    console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹æ¸²æŸ“');
    renderGridView();

    // ç»‘å®šè§†å›¾åˆ‡æ¢æŒ‰é’®
    document.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });
    });
});
</script>
{% endblock %}
